#!/bin/bash

set -e
set -o pipefail

WIKI_DIR="${WIKI_DIR:-$HOME/wiki}"
RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp}/wikimux"

if [ ! -d "$WIKI_DIR" ]; then
    echo "Creating wiki root at $WIKI_DIR..." >&2
    mkdir -p "$WIKI_DIR"
fi

if [ ! -d "$RUNTIME_DIR" ]; then
    mkdir -p "$RUNTIME_DIR"
fi

SESSION_NAME="wikimux"
WINDOW_NAME="main"

FINDER_PANE="$SESSION_NAME:$WINDOW_NAME.0"
HEADING_FINDER_PANE="$SESSION_NAME:$WINDOW_NAME.1"
EDITOR_PANE="$SESSION_NAME:$WINDOW_NAME.2"

has-session() {
    tmux has-session -t "$1" 2>/dev/null
}

send-editor-command() {
    local cmd="$@"

    if [ -z "$NVIM_ADDR"] || [ ! -S "$NVIM_ADDR" ]; then
        echo "could not find socket for wikimux neovim instance; is wikimux running?" >&2
        return 1
    fi

    nvim --server "$NVIM_ADDR" --remote-send "<C-\><C-N>$cmd<CR>"
}

open-note() {
    send-editor-command ":e $@"
}

open-note-split() {
    send-editor-command ":sp $@"
}

open-note-vsplit() {
    send-editor-command ":vs $@"
}

open-heading() {
    local line="$1"
    local filename="${@:2}"
    send-editor-command ":e $filename|$line"
}

open-heading-split() {
    local line="$1"
    local filename="${@:2}"
    send-editor-command ":sp $filename|$line"
}

open-heading-vsplit() {
    local line="$1"
    local filename="${@:2}"
    send-editor-command ":vs $filename|$line"
}

focus-editor() {
    tmux select-pane -t "$EDITOR_PANE"
}

list-notes() {
    find "$WIKI_DIR" -type f -name '*.md' -printf '%P\n'
}

list-headings() {
    local IFS=$'\n'
    for file in $(wikimux list-notes)
    do
        for match in $(grep -n '^#' "$WIKI_DIR/$file" | sed 's/^\([0-9]\+\):#\+ *\(.*\)/\2\t\1/')
        do
            echo "$match"$'\t'"$file"
        done
    done
}

finder() {
    wikimux list-notes | \
        fzf --scheme=path \
            --reverse \
            --border=none \
            --header="All Notes" \
            --bind "esc:clear-query" \
            --bind "enter:execute-silent(wikimux open-note {})+execute-silent(wikimux focus-editor)" \
            --bind "ctrl-h:execute-silent(wikimux open-note-split {})+execute-silent(wikimux focus-editor)" \
            --bind "ctrl-v:execute-silent(wikimux open-note-vsplit {})+execute-silent(wikimux focus-editor)" \
            --bind "ctrl-r:reload(wikimux list-notes)"
}

heading-finder() {
    wikimux list-headings | \
        fzf -d $'\t' \
            --with-nth "{1} ({3})" \
            --nth '1' \
            --reverse \
            --border=none \
            --header="All Headings" \
            --bind "esc:clear-query" \
            --bind "enter:execute-silent(wikimux open-heading {2} {3})+execute-silent(wikimux focus-editor)" \
            --bind "ctrl-h:execute-silent(wikimux open-heading-split {2} {3})+execute-silent(wikimux focus-editor)" \
            --bind "ctrl-v:execute-silent(wikimux open-heading-vsplit {2} {3})+execute-silent(wikimux focus-editor)" \
            --bind "ctrl-r:reload(wikimux list-notes)"

}

create-and-attach() {
    if ! has-session "$SESSION_NAME"; then
        NVIM_ADDR="$RUNTIME_DIR/nvim.$RANDOM.pipe"
        tmux new-session -d \
            -s "$SESSION_NAME" \
            -n "$WINDOW_NAME" \
            -c "$WIKI_DIR" \
            -e "NVIM_ADDR=$NVIM_ADDR" \
            "wikimux finder"

        tmux split-window -v -t "$FINDER_PANE" -c "$WIKI_DIR" "wikimux heading-finder"
        tmux resize-pane -t "$HEADING_FINDER_PANE" -y "25%"

        tmux split-window -hf -t "$SESSION_NAME:$WINDOW_NAME" -c "$WIKI_DIR" "nvim --listen '$NVIM_ADDR'"
        tmux resize-pane -t "$EDITOR_PANE" -x "67%"

        tmux select-pane -t "$FINDER_PANE"
    fi

    if [ -z "$TMUX" ]; then
        tmux attach -t "$SESSION_NAME"
    else
        tmux switch-client -t "$SESSION_NAME"
    fi
}

if [ "$#" -eq 0 ]; then
    create-and-attach
else
    $@
fi
