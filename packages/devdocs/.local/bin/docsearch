#!/bin/bash

set -e
set -o pipefail

FZF_ARGS=( "-d" $'\t' "--reverse" )

search-docsets() {
    devdocs docsets list --porcelain | fzf \
        "${FZF_ARGS[@]}" \
        --with-nth 1 \
        --bind "enter:execute(docsearch {2})"
}

search-entries() {
    local docset=$1
    devdocs entries list "$docset" --porcelain | fzf \
        "${FZF_ARGS[@]}" \
        --with-nth 3 \
        --bind "enter:execute(devdocs entries show '$docset' {1})"
}

case "$1" in
    "-h"|"--help")
        echo "Usage: docsearch [docset]"
        echo ""
        echo "  When called without a docset, opens fzf to pick one."
        echo ""
        echo "  For docsets, run: devdocs docsets list"
        echo ""
        exit
    ;;
esac

docset="$1"

if [ -z "$docset" ]; then
    search-docsets
else
    search-entries "$docset"
fi
