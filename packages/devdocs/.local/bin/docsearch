#!/bin/bash

set -e
set -o pipefail

TAB="$(printf '\t')"
FZF_ARGS=( "-d" "$TAB" "--reverse" "--no-clear" )

stage=1
docset=""
entry=""

_pick-docset() {
    devdocs docsets list --porcelain | fzf "${FZF_ARGS[@]}" --with-nth 1 | cut -d "$TAB" -f 2
}

_pick-entry() {
    devdocs entries list "$docset" --porcelain | fzf "${FZF_ARGS[@]}" --with-nth 3 | cut -d "$TAB" -f 1
}

_show-entry() {
    tput rmcup
    devdocs entries show "$docset" "$entry"
}

while true; do
    # echo "Stage: $stage, docset: $docset, entry: $entry"
   case $stage in
    1)
        docset="$(_pick-docset)" && ((stage++)) || ((stage--))
    ;;
    2)
        entry="$(_pick-entry)" && ((stage++)) || ((stage--))
    ;;
    3)
        (_show-entry) && ((stage++)) || ((stage--))
    ;;
    *)
        tput rmcup
        exit
    ;;
   esac
done

